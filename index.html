<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>太阳能投资蒙特卡洛模拟器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    input {
      padding: 5px;
      width: 100px;
    }
    label {
      margin-right: 10px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      margin-top: 10px;
    }
    #results {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>☀️ 太阳能投资蒙特卡洛模拟器</h1>

  <div class="input-group">
    <label>安装成本：</label><input type="number" id="cost" value="50000" /> 元
  </div>
  <div class="input-group">
    <label>年发电量：</label><input type="number" id="production" value="1500" /> kWh
  </div>
  <div class="input-group">
    <label>电价（起始）：</label><input type="number" id="price" value="0.6" step="0.01" /> 元/kWh
  </div>
  <div class="input-group">
    <label>光照效率均值：</label><input type="number" id="sunMean" value="0.8" step="0.01" />
    <label>标准差：</label><input type="number" id="sunStd" value="0.1" step="0.01" />
  </div>
  <div class="input-group">
    <label>电价增长率均值：</label><input type="number" id="growthMean" value="0.02" step="0.01" />
    <label>标准差：</label><input type="number" id="growthStd" value="0.03" step="0.01" />
  </div>

  <button onclick="runSimulation()">开始模拟</button>

  <div id="results"></div>

  <canvas id="chart" height="100"></canvas>

  <script>
    function randNorm(mean, stdDev) {
      // Box-Muller transform
      let u1 = Math.random();
      let u2 = Math.random();
      let randStdNormal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
      return mean + stdDev * randStdNormal;
    }

    function runSimulation() {
      const cost = parseFloat(document.getElementById("cost").value);
      const prod = parseFloat(document.getElementById("production").value);
      const priceStart = parseFloat(document.getElementById("price").value);
      const sunMean = parseFloat(document.getElementById("sunMean").value);
      const sunStd = parseFloat(document.getElementById("sunStd").value);
      const growthMean = parseFloat(document.getElementById("growthMean").value);
      const growthStd = parseFloat(document.getElementById("growthStd").value);

      const years = 20;
      const simulations = 100;
      const finalSavings = [];

      for (let i = 0; i < simulations; i++) {
        let price = priceStart;
        let total = 0;
        for (let y = 1; y <= years; y++) {
          let sunlight = randNorm(sunMean, sunStd);
          price *= 1 + randNorm(growthMean, growthStd);
          let savings = prod * sunlight * price;
          total += savings;
        }
        finalSavings.push(total);
      }

      const breakEvenCount = finalSavings.filter(v => v >= cost).length;
      const avg = finalSavings.reduce((a, b) => a + b, 0) / simulations;
      const max = Math.max(...finalSavings);
      const min = Math.min(...finalSavings);

      document.getElementById("results").innerHTML = `
        <h2>📊 模拟结果</h2>
        <p>模拟次数：${simulations}</p>
        <p>平均总收益：<strong>¥${avg.toFixed(0)}</strong></p>
        <p>回本概率（收益 ≥ ¥${cost}）：<strong>${((breakEvenCount / simulations) * 100).toFixed(1)}%</strong></p>
        <p>最高收益：¥${max.toFixed(0)}，最低收益：¥${min.toFixed(0)}</p>
      `;

      renderChart(finalSavings);
    }

    function renderChart(data) {
      const bins = Array(10).fill(0);
      const min = Math.min(...data);
      const max = Math.max(...data);
      const range = max - min;

      data.forEach(val => {
        let index = Math.floor((val - min) / range * bins.length);
        if (index >= bins.length) index = bins.length - 1;
        bins[index]++;
      });

      const labels = bins.map((_, i) => {
        const low = min + (range / bins.length) * i;
        return `¥${Math.round(low)}`;
      });

      if (window.myChart) window.myChart.destroy();
      const ctx = document.getElementById("chart").getContext("2d");
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '模拟收益分布',
            data: bins,
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  </script>
</body>
</html>